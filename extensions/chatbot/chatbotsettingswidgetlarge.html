<form id="extensionnametext_settingsform">
    <div class="form-group invisible">
        <input type="hidden" name="extensionname" class="form-control" value="extensionnametext" tabindex="-1" />
        <input type="hidden" name="modalcodetype" class="form-control" value="SettingsWidgetLargeCode" tabindex="-1" />
        <input type="hidden" name="modaldatatype" class="form-control" value="SettingsWidgetLargeData" tabindex="-1" />
        <input type="hidden" name="channel" class="form-control" value="channeltext" tabindex="-1" />
    </div>

    <h4 class="text-center">Chatbot Settings</h4>
    <p>Chatbot is a ChatGPT powered chatbot that can be asked questions or just hang out in chat talking with
        users. He can also process alerts (subs etc) to give a unique response
    </p>

    <!-- enable/disable chatbot -->
    <h5 class="text-center">Enablers</h5>
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="chatbotenabled" type="checkbox" id="chatbotenabled" chatbotenabledchecked>
            <label class="form-check-label" for="chatbotenabled">Enable Chatbot Autoresponse (joins in the conversation
                in
                chat)</label>
        </div>
    </div>
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="chatbottriggerenabled" type="checkbox" id="chatbottriggerenabled" chatbottriggerenabledchecked>
            <label class="form-check-label" for="chatbottriggerenabled">Enable Chatbot trigger (ie so chat will answer
                to questions that uses its name, or whatever is set in the trigger field below)</label>
        </div>
    </div>
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="questionbotenabled" type="checkbox" id="questionbotenabled" questionbotenabledchecked>
            <label class="form-check-label" for="questionbotenabled">Enable Question bot trigger (chat can ask questions
                directly)</label>
        </div>
    </div>
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="translatetoeng" type="checkbox" id="translatetoeng" translatetoengchecked>
            <label class="form-check-label" for="translatetoeng">English Translation trigger</label>
        </div>
    </div>
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="submessageenabled" type="checkbox" id="submessageenabled" submessageenabledchecked>
            <label class="form-check-label" for="submessageenabled">Enable sub/dono responses through chatbot</label>
        </div>
    </div>
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="generateimages" type="checkbox" id="generateimages" generateimageschecked>
            <label class="form-check-label" for="generateimages">Enable Image generation for responses
                chatbot</label>
        </div>
    </div>
    <!-- chatbot features settings -->
    <HR>
    <h4 class="text-center">Chatbot Auto Response</h4>
    <div class="form-group py-2">
        <div class="col-xs-1">
            <div class="form-group">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" name="chatbotpreviousresponseinhistoryenabled" type="checkbox" id="chatbotpreviousresponseinhistoryenabled"
                        chatbotpreviousresponseinhistoryenabledchecked>
                    <label class="form-check-label" for="chatbotenabled">Add last chatbot response to next history request</label>
                </div>
            </div>
            <BR>
            <label for="chatbotautoresponseengine">Engine to use (ie gpt-3.5-turbo, gpt-4 etc , not all are currently
                supported so check for console errors if it doesn't work)</label>
            <BR> <input type="text" name="chatbotautoresponseengine" id="chatbotautoresponseengine" value="chatbotautoresponseenginetext">

            <div class="form-group row-2 text-center">
                <div>Randomness.
                    Higher = more random/less precise
                    Lower = less random/more precise
                </div>
                <label for="chatbotautoresponsetemperature" class="form-label"
                    id="chatbotautoresponsetemperaturerangeval">chatbotautoresponsetemperaturetext</label>
                <input type="range" class="form-range" name="chatbotautoresponsetemperature" id="chatbotautoresponsetemperature" min="0" max="100" step="1"
                    onInput="$('#chatbotautoresponsetemperaturerangeval').html($(this).val())" value="chatbotautoresponsetemperaturetext">
            </div>
            <h5 class="text-center">Token Limit</h5>
            Limit the number of tokens used for the responce from OpenAI. Less tokens mean a shorter response. ~125
            tokens is around the max twitch chat length. Over this you will get multiple messages in chat.
            <div class="form-group">
                <div class="col-xs-1">
                    <label for="chatbotautoresponsemaxtokenstouse" class="col-form-label">Max Tokens to use:</label>
                    <input type="text" style="width: 40px" name="chatbotautoresponsemaxtokenstouse" id="chatbotautoresponsemaxtokenstouse"
                        value="chatbotautoresponsemaxtokenstousetext">
                </div>
            </div>
        </div>

    </div>
    <HR>
    <h4 class="text-center">Chatbot Trigger</h4>
    <div class="form-group py-2">
        <div class="col-xs-1">
            <label for="chatbotnametriggertag">Trigger that will cause the bot to parse the message, ie when someone
                mentions the bots name. Using TWITCHCHATBOTNAME will get replaced with your bots login name. This field
                name can be referenced below in the questions and answer section by using %%CHATBOTTRIGGERNAME%%. Note
                the bot will always respond to the twitch name as well as the shortened name here if used</label>
            <BR>
            <input type="text" name="chatbotnametriggertag" id="chatbotnametriggertag" value="chatbotnametriggertagtext">

            <label class="form-check-label" for="chatbotnametriggertagstartofline">Start of line only</label>
            <input class="form-check-input" name="chatbotnametriggertagstartofline" type="checkbox" id="chatbotnametriggertagstartofline"
                chatbotnametriggertagstartoflinechecked>

            <BR>
            <label for="chatbotnametriggerengine">Engine to use (ie gpt-3.5-turbo)</label>
            <BR> <input type="text" name="chatbotnametriggerengine" id="chatbotnametriggerengine" value="chatbotnametriggerenginetext">

            <div class="form-group row-2 text-center">
                <div>Randomness.
                    Higher = more random/less precise
                    Lower = less random/more precise
                </div>
                <label for="chatbotnametriggertemperature" class="form-label"
                    id="chatbotnametriggertemperaturerangeval">chatbotnametriggertemperaturetext</label>
                <input type="range" class="form-range" name="chatbotnametriggertemperature" id="chatbotnametriggertemperature" min="0" max="100" step="1"
                    onInput="$('#chatbotnametriggertemperaturerangeval').html($(this).val())" value="chatbotnametriggertemperaturetext">
            </div>
            <h5 class="text-center">Token Limit</h5>
            Limit the number of tokens used for the responce from OpenAI. Less tokens mean a shorter response. ~125
            tokens is around the max twitch chat length. Over this you will get multiple messages in chat.
            <div class="form-group">
                <div class="col-xs-1">
                    <label for="chatbotnametriggermaxtokenstouse" class="col-form-label">Max Tokens to use:</label>
                    <input type="text" style="width: 40px" name="chatbotnametriggermaxtokenstouse" id="chatbotnametriggermaxtokenstouse"
                        value="chatbotnametriggermaxtokenstousetext">
                </div>
            </div>
        </div>

    </div>
    <HR>
    <h5 class="text-center">Question Trigger</h5>
    <div class="form-group py-2">
        <div class="col-xs-1">
            <label for="chatbotquerytag">Message to directly ask a question in chat. The bot will look for this word in
                any chatmessage sent and will trigger a response when it see's the words/phrase.</label>
            <BR>
            <input type="text" name="chatbotquerytag" id="chatbotquerytag" value="chatbotquerytagtext">

            <label class="form-check-label" for="chatbotquerytagstartofline">Start of line only</label>
            <input class="form-check-input" name="chatbotquerytagstartofline" type="checkbox" id="chatbotquerytagstartofline" chatbotquerytagstartoflinechecked>

            <BR>
            <label for="chatbotqueryengine">Engine to use (ie gpt-3.5-turbo)</label>
            <BR> <input type="text" name="chatbotqueryengine" id="chatbotqueryengine" value="chatbotqueryenginetext">


            <div class="form-group row-2 text-center">
                <div>Randomness.
                    Higher = more random/less precise
                    Lower = less random/more precise
                </div>
                <label for="chatbotquerytemperature" class="form-label" id="chatbotquerytemperaturerangeval">chatbotquerytemperaturetext</label>
                <input type="range" class="form-range" name="chatbotquerytemperature" id="chatbotquerytemperature" min="0" max="100" step="1"
                    onInput="$('#chatbotquerytemperaturerangeval').html($(this).val())" value="chatbotquerytemperaturetext">
            </div>

            <h5 class="text-center">Token Limit</h5>
            <div class="form-group">
                <div class="col-xs-1">
                    <label for="chatbotquerymaxtokenstouse" class="col-form-label">Max Tokens to use:</label>
                    <input type="text" style="width: 40px" name="chatbotquerymaxtokenstouse" id="chatbotquerymaxtokenstouse"
                        value="chatbotquerymaxtokenstousetext">
                </div>
            </div>
        </div>
    </div>
    <HR>
    <h5 class="text-center">Translate to English Trigger</h5>
    <div class="form-group py-2">
        <div class="col-xs-1">
            <label for="translatetoengtag">Have the the bot translate a chat message to english (start the message with
                the following)</label>
            <BR> <input type="text" name="translatetoengtag" id="translatetoengtag" value="translatetoengtagtext">

            <BR>
            <label for="translatetoengengine">Engine to use (ie gpt-3.5-turbo)</label>
            <BR> <input type="text" name="translatetoengengine" id="translatetoengengine" value="translatetoengenginetext">

            <div class="form-group row-2 text-center">
                <div>Randomness.
                    Higher = more random/less precise
                    Lower = less random/more precise
                </div>
                <label for="translatetoengtagtemperature" class="form-label" id="translatetoengtagtemperaturerangeval">translatetoengtagtemperaturetext</label>
                <input type="range" class="form-range" name="translatetoengtagtemperature" id="translatetoengtagtemperature" min="0" max="100" step="1"
                    onInput="$('#translatetoengtagtemperaturerangeval').html($(this).val())" value="translatetoengtagtemperaturetext">
            </div>

            <h5 class="text-center">Token Limit</h5>
            <div class="form-group">
                <div class="col-xs-1">
                    <label for="translatetoengtagmaxtokenstouse" class="col-form-label">Max Tokens to use:</label>
                    <input type="text" style="width: 40px" name="translatetoengtagmaxtokenstouse" id="translatetoengtagmaxtokenstouse"
                        value="translatetoengtagmaxtokenstousetext">
                </div>
            </div>
        </div>
    </div>

    <hr>
    <h5 class="text-center">Activity level (how much the chatbot responds)</h5>
    <p>Timeout for bot. A random time will be selected between min and max, after chatting the bot will sleep for this
        random amount of time.</p>
    <div class="form-group py-2">
        <div class="col-xs-1">
            <label for="chatbotTimerMin" class="col-lg-1">Min (minutes): </label>
            <input type="text" class="col-lg-4" style="width: 40px;" name="chatbotTimerMin" id="chatbotTimerMin" value="chatbotTimerMintext">
        </div>
        <div class="col-xs-1">
            <label for="chatbotTimerMax" class="col-lg-1"> Max (minutes): </label>
            <input type="text" class="col-lg-4" style="width: 40px;" name="chatbotTimerMax" id="chatbotTimerMax" value="chatbotTimerMaxtext">
        </div>
    </div>
    <HR>
    <h5 class="text-center">Line count per request</h5>
    <p>This is how many messages to send to the AI bot. ie 5 means collect the next 5 messages (after the
        timeout above)and send them to get a response</p>
    <div class="form-group py-2">
        <div class="col-m-1">
            <label for="chatbotMessageMaxLines" class="">Num of messages : </label>
            <input type="text" style="width: 40px;" name="chatbotMessageMaxLines" id="chatbotMessageMaxLines" value="chatbotMessageMaxLinestext">
        </div>
    </div>
    <HR>
    <h5 class="text-center">Character count per request</h5>
    <a>How long should a message be before it is added to the list to send to the bot. Short messages 'hello',
        'nice one' or a Bttv emote (can't easily filter these out yet)
        don't make for such a good responce.</a>
    <div class="form-group py-2">
        <div class="col-m-1">
            <label for="chatbotminmessagelength" class="">Minimum char length of a message</label>
            <input type="text" style="width: 40px;" name="chatbotminmessagelength" id="chatbotminmessagelength" value="chatbotminmessagelengthtext">
        </div>
    </div>
    <HR>
    <h5 class="text-center">Typing delay</h5>
    <a> Mimics a delay for typing. Value is seconds per word or 0 if you want it to respond as
        soon as it can (this is multiplied by the number of words in the chatbots reply and then it will delay for that
        length of
        time before posting back). </a>
    <div class="form-group py-2">
        <div class="col-m-1">
            <label for="chatbottypingdelay" class="">Delay per word in seconds</label>
            <input type="text" style="width: 40px;" name="chatbottypingdelay" id="chatbottypingdelay" value="chatbottypingdelaytext">
        </div>
    </div>
    <HR>
    <h5 class="text-center">Ignore list</h5>
    <a>The list of users that will ignored by the AI bot (ie spammers, chatbots etc). Separate names with a ',' </a>
    <div class="form-group py-2">
        <div class="col-m-3">
            <label for="chatbotignorelist" class="">List of names that the bot will ignore</label>
            <input type="text" style="width: 80%;" name="chatbotignorelist" id="chatbotignorelist" value="chatbotignorelisttext">
        </div>
    </div>
    <h5 class="text-center">AI images</h5>
    <div class="form-group py-2">
        <div class="col-xs-1">
            <label for="savedir">Save directory for images</label>
            <BR> <input type="text" name="savedir" id="savedir" value="savedirtext">

            <BR>
            <label for="livedir">Directory to save to while live (moved to save directory on next stream)</label>
            <BR> <input type="text" name="livedir" id="livedir" value="livedirtext">
        </div>
    </div>
    <hr>
    <h5 class="text-center">Personalities</h5>
    <a>Define the personalities for each preset below. Note you can use %%CHATBOTTRIGGERNAME%% which will get replaced
        with the bot name specified in the above field</a>
    <!-- ####################################################### -->
    <!--              behaviour and personalities                -->
    <!-- ####################################################### -->
    <div class="form-group row-2" class="form-control">
        <h4>Profile in use:<span style='color: yellow'> chatbotprofileselectedname</span></h4>
        <select class="selectpicker btn-secondary" data-style="btn-danger" data-width="150px" title="box one" id="chatbotprofilepicker"
            value="chatbotprofilepickervalue" name="chatbotprofilepicker" onchange="
                        let wc_i = this.selectedIndex; 
                        Array.apply(null,this.options).forEach(x => 
                        {
                            document.getElementById('chatbotprofile' + x.value+'profile').style.visibility ='hidden'
                            document.getElementById('chatbotprofile' + x.value+'profile').style.display ='none'
                        })
                        let selectedElement = document.getElementById('chatbotprofile' + this.options[wc_i].value+'profile')                    
                        selectedElement.style.visibility ='visible'
                        selectedElement.style.display ='block'
                " required>
            chatbotprofileoptionssplaceholder
        </select>
    </div>
    chatbotprofileandbehavioursplaceholder

    <!-- ####################################################### -->
    <!--          end behaviour and personalities                -->
    <!-- ####################################################### -->
    <div class="form-group row-2" class="form-control">
        <!--
         Load Save chatbot settings files
    -->
        <HR class="hrbold">
        <div class="container-fluid">
            <H3>Save/Load Chatbot Config Files</H3>
            These files contain all your saved chatbot profiles and settings
            <BR>Please note that if loading older files they may fail
            due to outdated version numbers.
            <BR>
            <h5>Manually Editing the files</H5>
            You can manually edit these files if you wish to edit profiles in a text editor
            The Version number should only change when the fields have changed, you only need to change these values to
            match the latest version numbers if you are copying an older config over to a newer one.
            I'd suggest saving the current config, then copy/pasting your changes into the fields but leave the version
            number as it is saved from streamroller
            <HR>

            <div class="row">
                <div class="col-6 px-3">
                    <div class="form-group">
                        <!--<h5>Download the chatbot Server Data File</h5>-->
                        <label class="form-label" for="uploadChatbotFileButton">Download the chatbot Server Data File</label>
                        <!--<form id="uploadChatbotFileButton"
                            class="form-inline">-->
                        <button type="button" class="btn btn-secondary" onclick="return downloadServerDataClicked()">Download</button>
                        <!-- </form> -->
                    </div>
                </div>
                <div class="col-6 px-3">
                    <div class="form-group">
                        <!-- <h5>Upload a Server Data File</h5>-->
                        <label class="form-label" for="ChatBotDatFileUploadElement">Upload an chatbot Server Data File</label>
                        <!-- <form class="form-inline"> -->
                        <input type="file" name="" class="form-control" id="ChatBotDatFileUploadElement">
                        <BR>
                        <button type="button" id="Upload" class="btn btn-secondary" onclick="uploadServerDataClicked()">Upload ChatBot data file</button>
                        <div id="ChatBotDatFileUploadMessage"></div>
                        <!--/form> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <HR>
    <H2>Open AI access key</H2>
    <div class="form-group">
        <label for="chatbot_openAIKey" class="col-form-label">Enter your openAI token here (can be obtained by going to
            <a href="https://platform.openai.com/account/api-keys">https://platform.openai.com/account/api-keys</a>)</label>
        <input type="password" name="chatbot_openAIKey" class="form-control" id="chatbot_openAIKey" value="empty">
    </div>

    <HR>
    <h5 class="text-center">Debug</h5>
    Outputs some extra text in the console for help to tune things better.
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="DEBUG_MODE" type="checkbox" id="DEBUG_MODE" DEBUG_MODEchecked>
            <label class="form-check-label" for="DEBUG_MODE">Enable debug messages</label>
        </div>
    </div>
    <div class="form-group">
        <div class="form-check form-check-inline">
            <input class="form-check-input" name="extensionnametext_restore_defaults" type="checkbox" id="extensionnametext_restore_defaults"
                extensionnametext_restore_defaultschecked>
            <label class="form-check-label" for="extensionnametext_restore_defaults">Restore Defaults</label>
        </div>
    </div>
    <div class="modal-footer">
        <button id="closeSettingschatbot" type="close" class="btn btn-secondary">Close</button>
        <button type="submit" class="btn btn-primary">Update</button>
    </div>

</form>
<script type="text/javascript">
    // ============================================================================
    //                     FUNCTION: downloadServerDataClicked
    // ============================================================================
    function downloadServerDataClicked ()
    {
        // User has clicked on the download Server Data Button
        try
        {
            RequestServerDataFile();
        }
        catch (err)
        {
            console.log("downloadServerDataClicked Error:", err, err.message)
        }
    }

    // ============================================================================
    //                     FUNCTION: RequestServerDataFile
    // ============================================================================
    function RequestServerDataFile ()
    {
        // request the saved data from the server (callback will go to downloadServerDataFileReceived below)
        sr_api.sendMessage(
            DataCenterSocket,
            sr_api.ServerPacket(
                "ExtensionMessage",
                serverConfig.extensionname,
                sr_api.ExtensionPacket(
                    "RequestServerDataFile",
                    serverConfig.extensionname,
                    "",
                    "",
                    "chatbot"
                ),
                "",
                "chatbot"
            ));
    }
    // ============================================================================
    //                     FUNCTION: uploadServerDataClicked
    // ============================================================================
    function uploadServerDataClicked ()
    {
        try
        {
            // user has selected a file to upload to the server
            var file = document.getElementById('ChatBotDatFileUploadElement').files[0];
            if (file)
            {
                var reader = new FileReader();
                reader.readAsText(file, "application/json");
                reader.onload = function (evt)
                {
                    let userDataFile = JSON.parse(evt.target.result);
                    // some basic sanity checks.
                    if (userDataFile && userDataFile != ""
                        && userDataFile.__version__)
                    {
                        document.getElementById('ChatBotDatFileUploadMessage').innerHTML = "Processing";
                        processingAnimation('ChatBotDatFileUploadMessage');
                        saveUserDataFile(userDataFile)
                    }
                    else
                    {
                        document.getElementById('ChatBotDatFileUploadMessage').innerHTML = "Error reading file, is it the correct format"
                    }
                }
            } else
                document.getElementById('ChatBotDatFileUploadMessage').innerHTML = "Error reading file, is it the correct format"
        }
        catch (err)
        {
            console.log("uploadServerDataClicked Error:", err, err.message)
        }
    }
    // ============================================================================
    //                     FUNCTION: saveUserDataFile
    // ============================================================================
    function saveUserDataFile (userDataFile)
    {
        // request the saved data from the server (callback will go to downloadServerDataFileReceived below)
        sr_api.sendMessage(
            DataCenterSocket,
            sr_api.ServerPacket(
                "ExtensionMessage",
                serverConfig.extensionname,
                sr_api.ExtensionPacket(
                    "userRequestSaveDataFile",
                    serverConfig.extensionname,
                    userDataFile,
                    "",
                    "chatbot"
                ),
                "",
                "chatbot"
            ));
    }
    // ============================================================================
    //                     FUNCTION: getFileNameDateString
    // ============================================================================
    function getFileNameDateString ()
    {
        // returns a suitable date string for appending to a filename
        const date = new Date();
        const year = date.getFullYear();
        const month = `${date.getMonth() + 1}`.padStart(2, '0');
        const day = `${date.getDate()}`.padStart(2, '0');
        const hours = `${date.getHours()}`.padStart(2, '0');
        const minutes = `${date.getMinutes()}`.padStart(2, '0');
        const seconds = `${date.getSeconds()}`.padStart(2, '0');
        return `${year}_${month}_${day}-${hours}_${minutes}_${seconds}`
    }

</script>